{"componentChunkName":"component---src-templates-notes-js","path":"/k8s","result":{"data":{"markdownRemark":{"html":"<h2>Architecture</h2>\n<ul>\n<li>\n<p>node (minions)</p>\n<ul>\n<li>node is where your application runs on</li>\n</ul>\n</li>\n<li>\n<p>cluster</p>\n<ul>\n<li>multiple nodes form cluster</li>\n</ul>\n</li>\n<li>\n<p>master</p>\n<ul>\n<li>master is a node, it monitor and orchestrate</li>\n</ul>\n</li>\n</ul>\n<p>Components</p>\n<ul>\n<li>API Server: cli, management ui talks with api server</li>\n<li>etcd: distributed key-value store, implment locks</li>\n<li>kubelet: agent runs on each node in cluster</li>\n<li>Container runtime: underline runtime to run container (e.g. docker, rkt, cri-o)</li>\n<li>Controller: brain of orchestration, respond to down load</li>\n<li>Scheduler: distribute work to containers</li>\n</ul>\n<p>Master &#x26; worker nodes\nmaster</p>\n<ul>\n<li>kube-apiserver</li>\n<li>etcd</li>\n<li>controller</li>\n<li>scheduler</li>\n</ul>\n<p>worker</p>\n<ul>\n<li>container runtime</li>\n<li>kubelet</li>\n</ul>\n<p><code class=\"language-text\">kubectl</code>\ncli tool for managing k8s cluster</p>\n<h2>Core</h2>\n<h3>Pods</h3>\n<p>usually one container application per pod, multiple pods per node.</p>\n<p>you can have multiple container per pod, but in this case, they should be tightly coupled. One needs another to run, one dies with anther.</p>\n<p>pod handles shared volume, network automatically.</p>\n<p><strong>deploy pod</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl run nginx --image nginx</code></pre></div>\n<p><strong>list pods</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl get pods</code></pre></div>\n<p><strong>create pods via YAML</strong></p>\n<p><code class=\"language-text\">pod-definition.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp<span class=\"token punctuation\">-</span>pod\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> front<span class=\"token punctuation\">-</span>end\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx</code></pre></div>\n<h3>Replica sets</h3>\n<p>Replication controller is the old way. New recommendation to use replica set.</p>\n<h4>create replication controller</h4>\n<p><code class=\"language-text\">rc-definition.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ReplicationController\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp<span class=\"token punctuation\">-</span>rc\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> front<span class=\"token punctuation\">-</span>end\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># copied from our pod-definition above</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp<span class=\"token punctuation\">-</span>pod\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> front<span class=\"token punctuation\">-</span>end\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token comment\"># how many pod replica we need</span></code></pre></div>\n<p>then</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create -f rc-definition.yml</code></pre></div>\n<p>view created rc and pods:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl get replicationcontroller\nkubectl get pods</code></pre></div>\n<h4>Create replica set</h4>\n<p><code class=\"language-text\">replicaset-definition.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1 <span class=\"token comment\"># note the difference</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ReplicaSet\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp<span class=\"token punctuation\">-</span>replicaset\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># same</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> myapp<span class=\"token punctuation\">-</span>pod\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> myapp\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> front<span class=\"token punctuation\">-</span>end\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>container\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> front<span class=\"token punctuation\">-</span>end\n  <span class=\"token comment\"># replica set use selector to identify which pods fall under it</span>\n  <span class=\"token comment\"># replica set can also manage pods not created by the replica set.</span></code></pre></div>\n<p>then</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create -f replicaset-definition.yml</code></pre></div>\n<p>view created replica set and pods:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl get replicaset\nkubectl get pods</code></pre></div>\n<h4>Labels and selectors</h4>\n<p>Replica set can monitor existing pods, that's why it use selectors and why labels are useful.</p>\n<h4>Scaling</h4>\n<p>modify definition file and then run</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl replace -f replicaset-definition.yml</code></pre></div>\n<p>or directly without editing the file (file content will not change)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl scale --replicas=6 -f replicaset-definition.yml</code></pre></div>\n<p>or similarly, but with type and name</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl scale --replicas=6 replicaset myapp-replicaset</code></pre></div>\n<h3>Deployments</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\">#...</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span>\n  selector<span class=\"token punctuation\">:</span></code></pre></div>\n<h2>Configuration</h2>\n<h3>Command and args</h3>\n<h3>Config Maps</h3>\n<h3>Secrets</h3>\n<h3>Resource requirements and limits</h3>\n<h3>Taints and Tolerances</h3>\n<ul>\n<li>Tainted node only accept nodes with the right toleration.</li>\n<li>\n<p>Doesn't prevent pod with the right toleration to schedule on untainted nodes.</p>\n<blockquote>\n<p>effect is that a node can accept some pods but not other pods.</p>\n</blockquote>\n</li>\n</ul>\n<h3>Node affinity</h3>\n<ul>\n<li>Pod with affinity (via label selector) can only (or preferred) be scheduled to matching node.</li>\n<li>\n<p>Doesn't prevent pod without affinity to be scheduled on these nodes.</p>\n<blockquote>\n<p>effect is that the pod can go on some nodes but not other nodes.</p>\n</blockquote>\n</li>\n</ul>\n<p>(need to use both taints/toleration and node affinity, if you need guarantee a node only accept some pod, and these pod can only be scheduled on said node).</p>\n<h2>Security</h2>\n<h3>Docker Security</h3>\n<h4>Linux Capabilities</h4>","frontmatter":{"title":"Kubernetes (K8s)"},"parent":{"__typename":"File","modifiedTime":"2021-10-26T14:41:02.019Z"}}},"pageContext":{}}}