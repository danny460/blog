{"componentChunkName":"component---src-templates-notes-js","path":"/mysql","result":{"data":{"markdownRemark":{"html":"<h1>MySQL</h1>\n<h2>Arch</h2>\n<h2>Transactions</h2>\n<p>A transaction is an atomic set of SQL queries, a single unit of work. Either all of them are executed or none.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">START</span> <span class=\"token keyword\">TRANSACTION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> balance <span class=\"token keyword\">FROM</span> checking <span class=\"token keyword\">WHERE</span> customer_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> checking <span class=\"token keyword\">SET</span> balance <span class=\"token operator\">=</span> balance <span class=\"token operator\">-</span> <span class=\"token number\">200.00</span> <span class=\"token keyword\">WHERE</span> customer_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> savings <span class=\"token keyword\">SET</span> balance <span class=\"token operator\">=</span> balance <span class=\"token operator\">+</span> <span class=\"token number\">200.00</span> <span class=\"token keyword\">WHERE</span> customer_id <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>ACID</h3>\n<p>the criteria that a well-behaved transaction processing system must meet:</p>\n<ul>\n<li>Atomicity</li>\n<li>Consistency</li>\n<li>Isolation</li>\n<li>Durability</li>\n</ul>\n<h3>Isolation level</h3>\n<p>Isolation level is related to transactions and concurrency. It defines how to sperate each transaction from other concurrently running transactions.</p>\n<p>The SQL standard defines four isolation levels, with specific rules for which changes are and aren't visible inside and outside a transaction:\n| Level | Description | Lock |\n| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |\n| <code class=\"language-text\">READ UNCOMMITED</code> | The lowest level. Basically no isolation. Transactions can view the results of uncommited transactions (aka. <em>dirty read</em>). This level is rarely used in practice. | no lock |\n| <code class=\"language-text\">READ COMMITTED</code> | Transaction will see only chances made by transactions that were already commited, and its changes won't be visible to others until it has commited. However, this level allows <em>nonrepeatable read</em>, which means you can run the same <code class=\"language-text\">SELECT</code> statement twice and see different results, because they each use a different snapshot of data. | |\n| <code class=\"language-text\">REPEATABLE READ</code> (<strong>default</strong>) | Gurantees same results from multiple read in a transaction. Still allows <em>phantom read</em>, which can happen when we read a range of rows but another transaction inserted a new row in the range. The inserted row will be read by current transaction, so called phantom. (InnonDB has <strong>MVCC</strong> to solve this problem). | lock write |\n| <code class=\"language-text\">SERIALIZABLE</code> | The highest level. Gurantees no phantom read by locking every row it reads, forcing transactions to be ordered. | S lock for read, X lock for write |</p>\n<p>Note that higher isolation level operates with more overheads, so generally the performance and concurrency is worse. It's always a trade-off.</p>\n<h4>Difference between non-repeatable read &#x26; phantom read:</h4>\n<ul>\n<li>In <code class=\"language-text\">READ COMMITED</code>, read doesn't place lock. Update and delete of selected role can still happen, consequently you would read different results in subsequent reads.</li>\n<li>In <code class=\"language-text\">REPEATABLE READ</code>, read locks rows from updating/deletion, but it does not prevent insertion. Insertion can still happen which would results in phantom read in subsequent reads.</li>\n</ul>\n<h4>MVCC (multi-version concurrency control)</h4>\n<p>Store 2 hidden value with each row, one for</p>\n<h2>Locking</h2>\n<h3>Optimistic lock</h3>\n<p>乐观锁（Optimistic Lock），顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在提交更新的时候会判断一下在此期间别人有没有去更新这个数据。乐观锁适用于读多写少的应用场景，这样可以提高吞吐量。</p>\n<p>乐观锁一般来说有以下 2 种方式：</p>\n<ol>\n<li>使用数据版本（Version）记录机制实现，这是乐观锁最常用的一种实现方式</li>\n<li>使用时间戳（timestamp）</li>\n</ol>\n<p>Java 中的 atomic 包就是乐观锁的一种实现，AtomicInteger 通过 CAS（Compare And Set）操作实现线程安全的自增。</p>\n<h3>Pessimistic lock</h3>\n<p>顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁。</p>\n<p>Java 的 <code class=\"language-text\">synchronized</code> 就属于悲观锁的一种实现，每次线程要修改数据时都先获得锁，保证同一时刻只有一个线程能操作数据，其他线程则会被 block。</p>\n<h3>MySQL 隐式和显示锁定</h3>\n<p>MySQL InnoDB 采用的是两阶段锁定协议（two-phase locking protocol）。在事务执行过程中，随时都可以执行锁定，锁只有在执行 <code class=\"language-text\">COMMIT</code>或者<code class=\"language-text\">ROLLBACK</code>的时候才会释放，并且所有的锁是在同一时刻被释放。前面描述的锁定都是隐式锁定，InnoDB 会根据事务隔离级别在需要的时候自动加锁。</p>\n<p>另外，InnoDB 也支持通过特定的语句进行显示锁定，这些语句不属于 SQL 规范：</p>\n<p>SELECT ... LOCK IN SHARE MODE</p>\n<p>SELECT ... FOR UPDATE</p>\n<h2>Storage Engines</h2>\n<h3>InnoDB</h3>\n<h3>MyISAM</h3>\n<h3>Main difference: InnoDB &#x26; MyISAM</h3>\n<ul>\n<li>InnoDB has row-level locking, MyISAM only have full table lock.</li>\n<li>InnoDB has support for transactions.</li>\n<li>InnoDB has foreign key and constraints.</li>\n</ul>\n<h2>Indexing</h2>\n<p>Indexes are data structures the storage engines use to lookup rows quickly.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> myindex <span class=\"token keyword\">ON</span> order_table<span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">,</span> create_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>or with unique constraint</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span> myindex <span class=\"token keyword\">ON</span> order_table<span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">,</span> create_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>BTREE Index</h3>\n<p>BTREE here is refering a class of index MySQL uses. However, the actual data structure used differs among storage engines. For example, NDB uses T-Tree and InnoDB uses B+Tree.</p>\n<h4>Data Structure: B-Tree</h4>\n<p>B-Tree is a self-balancing m-ary tree (m > 2). B-tree maintains sorted data and allow searches, insert, delete in <code class=\"language-text\">O(logN)</code> time. B-Tree is commonly used in file systems and databases.</p>\n<blockquote>\n<p><strong>Note: Why not use a balanced binary tree?</strong> - Each node in a B-Tree can represent much more data, which reduce the height of the tree. Because database need to read data from disk storage in to memory, a reduced height means less disk I/O and better performance.</p>\n</blockquote>\n<h4>Data Structure: B+Tree</h4>\n<p>B+Tree is a variation of B-Tree:</p>\n<ul>\n<li>\n<p>number of key is the same as number of children</p>\n<ul>\n<li>This is unlike B-Tree, where a node with <code class=\"language-text\">n</code> keys has <code class=\"language-text\">n + 1</code> children. In B+Tree, the key represent the maximum value a child can have.</li>\n</ul>\n</li>\n<li>non-leaf node are only used for indexing and not data reading.</li>\n<li>leaf nodes have all the data, and each leaf node has a pointer to the adjacent node (as a linked list).</li>\n</ul>\n<p>The advantage of using B+Tree:</p>\n<ul>\n<li>In practice, because B+Tree's non-leaf node hold less data, a storage page can store more entries per node. This reduces the height of the tree by more, and leads to less disk I/O.</li>\n<li>The leaf nodes is a sorted linked list, makes it more efficient to search range of data.</li>\n</ul>\n<h3>Hash Index</h3>\n<p>Implemented using hash table.\nMemory storage engine</p>\n<h3>Cluster Index</h3>\n<p>Cluster index is not a index, but it is rather about how the index is stored. InnoDB stores the index and the rows together in the same structure (in leaf pages). InnoDB clusters the data by the primary key.</p>\n<h2>Optimizing index</h2>\n<h2>MySQL vs MongoDB?</h2>\n<ul>\n<li>Fixed schema vs dynamic schema.</li>\n<li>Mongodb is document-oriented. stores data in json format (BSON)</li>\n<li>\n<p>MySQL is vertically scalable, while mongodb is horizontally scalable.</p>\n<ul>\n<li>MySQL master-slave structure scales read, but write is still limitation. MongoDB sharding distribute both read and write.</li>\n</ul>\n</li>\n<li>MySQL has table-based relational structure.</li>\n</ul>\n<h2>MySQL scaling</h2>\n<h2>RDBS Database normalization</h2>\n<p>not normalized database have data redundancy.</p>\n<h3>1NF</h3>\n<p>column value should be single (not like an array of values)\nvalues stored in column should be of the same domain\ncolumn have unique names\norder does not matter</p>\n<h3>2NF</h3>\n<p>must be in 1NF\nno partial dependency. (all column value is dependent on primary key)</p>\n<h3>3NF</h3>\n<p>must be in 2NF\nno transitive dependency.</p>\n<h3>BCNF</h3>\n<p>must be in 3NF\neach functional dependency (x -> y), x should be a super key</p>\n<h3>4NF</h3>\n<p>must be in BCNF\nno multi-valued-dependency</p>","frontmatter":{"title":"MySQL"},"parent":{"__typename":"File","modifiedTime":"2021-10-26T14:41:02.019Z"}}},"pageContext":{}}}