<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/cs-notes/styles.7f67dccd6da6a9c0ed60.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.grds-color{flex-basis:300px!important;max-width:300px!important}.grds-wrapper{color:#000;margin-bottom:24px}@media (max-width:700px){.grds-wrapper{flex-basis:100%!important;max-width:100%!important;margin:0 0 24px}}.grds-audio{margin-right:10px}.grds-audio__container{background:#f4f6f8;padding:20px;border-radius:10px;width:100%}.grds-audio__title{margin-bottom:1rem;display:flex;align-items:center}.grds-audio__title svg{height:25px;width:25px;fill:#48ba6f;margin-right:1.5rem}.grds-audio__audiofile{width:100%}.grds-color{display:inline-block!important;margin-right:10px}@media (max-width:700px){.grds-color{display:block!important}}.grds-color__container{border-radius:10px;width:300px;display:flex;flex-direction:column}@media (max-width:700px){.grds-color__container{width:100%}}.grds-color__swatch{height:150px;border-radius:10px 10px 0 0;position:relative;display:flex;align-items:flex-end;padding-bottom:10px;justify-content:center}.grds-color__swatch__a11y{display:flex;flex-direction:column;width:50px;margin:0 3px}.grds-color__swatch__a11y__char{color:#fff;text-align:center}.grds-color__swatch__a11y__status{color:#fff;background:#000;padding:2px 5px;display:inline-block;border-radius:5px;font-size:.9rem;text-align:center}.grds-color__info{display:flex;flex-wrap:wrap;padding:10px;background:#f4f6f8;border-radius:0 0 10px 10px}.grds-color__info__item{margin-bottom:1rem;margin-top:.5rem;flex-basis:50%}.grds-color__info__item .clippy{display:inline-block}.grds-color__info__item p:first-child{text-transform:uppercase;color:#7d858c;font-size:.75rem}.grds-color__info__item p{margin-bottom:.25rem;margin-top:.5rem}.grds-color-palette__container{background:#f4f6f8;border-radius:10px;width:100%}.grds-color-palette__item{padding:20px;border-bottom:2px solid #c5d3e0;display:flex;justify-content:space-between;flex-wrap:wrap}.grds-color-palette__item:last-child{border-bottom:none}.grds-color-palette__left,.grds-color-palette__right{display:flex;align-items:center;flex-wrap:wrap}.grds-color-palette__item__swatch{width:50px;height:50px;border-radius:10px;margin-right:20px;margin-top:10px;margin-bottom:10px}.grds-color-palette__item__name{padding:.5rem 1rem .5rem 0}.grds-color-palette__item__color:first-child{width:115px}.grds-color-palette__item__color{margin:.4rem 0;width:140px}.grds-color-palette__item__color span:first-child{background:#c5d3e0;color:#2e2e2e;padding:3px 5px;font-size:.7rem;border-radius:5px}.grds-color-palette__item__color span:last-child{margin-left:.25rem;font-size:.9rem}.grds-download{margin-right:10px}.grds-download__container{background:#f4f6f8;padding:20px;border-radius:10px;width:100%;text-decoration:none}.grds-download__info{justify-content:space-between}.grds-download__info,.grds-download__info__left{display:flex;align-items:center}.grds-download__info__left svg{height:25px;width:25px;fill:#48ba6f;margin-right:1.5rem}.grds-download__info__right{font-size:.75rem;color:#7d858c}.grds-download__preview{padding:20px;border-radius:10px;margin-top:40px;display:flex;justify-content:center;box-shadow:0 5px 15px rgba(0,0,0,.1)}.grds-download__image{-o-object-fit:cover;object-fit:cover;height:100%;margin-bottom:0}.grds-example{border-radius:10px;border:1px solid #c5d3e0}.grds-example__container,.grds-hint{padding:20px}.grds-hint{border-radius:10px;background:#f4f6f8;color:#7a7d80;border:1px solid #d9eafa;width:100%}.grds-hint__directive{background:#ecfaea;color:#307c3f;border:1px solid #c0ebc8}.grds-hint__warning{background:#fef5f5;color:#c93a3c;border:1px solid #fcddde}.grds-typo__container{width:100%}.grds-typo__item{display:flex;flex-direction:column;border-bottom:2px solid #c5d3e0;padding-bottom:1rem;margin-bottom:2rem}.grds-typo__item__name{margin-bottom:1.5rem}.grds-typo__item__info{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:flex-start;width:100%}.grds-typo__item__info p:first-child{text-transform:uppercase;font-size:.75rem;color:#7d858c;margin-bottom:0}.grds-typo__item__info p:last-child{margin-top:.5rem}.grds-typo__item__info__desc{margin-right:2rem}.grds-video{margin-right:10px}.grds-video__container{background:#f4f6f8;padding:20px;border-radius:10px;width:100%}.grds-video__title{margin-bottom:15px;display:flex;align-items:center}.grds-video__title svg{height:25px;width:25px;fill:#48ba6f;margin-right:1.5rem}.grds-video__videofile{width:100%}.clippy:hover{cursor:pointer}.tooltipped{position:relative}.tooltipped:after{z-index:1000000;padding:.1rem .3rem;font:normal normal 11px/1.5 sans-serif;-webkit-font-smoothing:subpixel-antialiased;color:#fff;text-align:center;text-shadow:none;text-transform:none;letter-spacing:normal;word-wrap:break-word;white-space:pre;content:attr(aria-label);background:#000;border-radius:3px}.tooltipped:after,.tooltipped:before{position:absolute;display:inline-block;text-decoration:none;pointer-events:none}.tooltipped:before{z-index:1000001;width:0;height:0;color:#000;content:"";border:6px solid transparent}.tooltipped-n:after{right:50%;bottom:100%;margin-bottom:6px}.tooltipped-n:before{top:-7px;right:50%;bottom:auto;margin-right:-6px;border-top-color:#000}.tooltipped-n:after{transform:translateX(50%)}.s11jhqd8{height:60px;width:100%;background-color:#639}.h2h01z2{margin:0;max-width:960px;padding:20px 1rem}.hkd2pf6{margin:0}.h6fgol{color:#fff;-webkit-text-decoration:none;text-decoration:none}.s1x3km3v{border-right:1px solid #d3d3d3;width:350px;height:100%;min-height:100%;padding:1rem}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#___gatsby,#gatsby-focus-wrapper,body,html{height:100%;width:100%;overflow:hidden}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.5 georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.51572rem}h3{font-size:1.31951rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}.ggj4icz{display:grid;grid-template-columns:auto 1fr;grid-template-rows:auto 1fr;grid-template-areas:"header header" "sidebar main";min-height:100%;height:100%}.hug0csx{grid-area:header}.s1p3sm64{grid-area:sidebar}.m1dsv0mj{grid-area:main;overflow-y:scroll}.c1swtufw{padding:1.5rem;margin:0 auto;max-width:960px}</style><meta name="generator" content="Gatsby 2.20.35"/><title data-react-helmet="true"></title><link rel="icon" href="/cs-notes/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/cs-notes/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/cs-notes/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/cs-notes/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/cs-notes/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/cs-notes/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/cs-notes/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/cs-notes/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/cs-notes/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/cs-notes/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/cs-notes/webpack-runtime-5bb415d6ec02a3077fde.js"/><link as="script" rel="preload" href="/cs-notes/framework-a74044b4add31353c05b.js"/><link as="script" rel="preload" href="/cs-notes/app-3326c647442d9cdf5b1f.js"/><link as="script" rel="preload" href="/cs-notes/styles-6b8affa5cc22cb60670e.js"/><link as="script" rel="preload" href="/cs-notes/3925cf68b2c2d0cc1d85efad3e08a114191829f9-472ce0b777b01331616f.js"/><link as="script" rel="preload" href="/cs-notes/component---src-templates-notes-js-d8a721f12764927d7a7b.js"/><link as="fetch" rel="preload" href="/cs-notes/page-data/mysql/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/cs-notes/page-data/app-data.json" crossorigin="anonymous"/><style data-linaria-critical="/mysql"></style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="ggj4icz"><div class="hug0csx"><header class="s11jhqd8"><div class="h2h01z2"><h5 class="hkd2pf6"><a class="h6fgol" href="/cs-notes/">CS Study Notes</a></h5></div></header></div><div class="s1p3sm64"><nav class="s1x3km3v" role="navigation"><legend></legend><ul><li><legend>Java</legend><ul><li><a href="/cs-notes/java/collection-framework">Java Collection Framework</a></li><li><a href="/cs-notes/java/io">I/O in Java</a></li><li><a href="/cs-notes/java/jmm">Java Memory Model (JMM)</a></li><li><a href="/cs-notes/java/jvm">Java Virtual Machine (JVM)</a></li><li><a href="/cs-notes/java/multithreading-concurrency">Multi-threading and Concurrency in Java</a></li></ul></li><li><a href="/cs-notes/k8s">Kubernetes (K8s)</a></li><li><a aria-current="page" class="" href="/cs-notes/mysql">MySQL</a></li><li><legend>Networking</legend><ul><li><a href="/cs-notes/networking/http">HTTP</a></li><li><a href="/cs-notes/networking/transport-layer-protocols">Transport Layer Protocols</a></li></ul></li><li><legend>Operating System</legend><ul><li><a href="/cs-notes/operating-system/file-system">File System</a></li><li><a href="/cs-notes/operating-system/inter-process-communication">Inter-process Communication</a></li><li><a href="/cs-notes/operating-system/memory-management">Memory Management</a></li><li><a href="/cs-notes/operating-system/process-and-thread">Process and thread</a></li></ul></li></ul></nav></div><div class="m1dsv0mj"><main class="c1swtufw"><div class="blog-post-container"><div class="blog-post"><h1>MySQL</h1><p>1 minutes ago</p><div class="blog-post-content"><h1>MySQL</h1>
<h2>Arch</h2>
<h2>Transactions</h2>
<p>A transaction is an atomic set of SQL queries, a single unit of work. Either all of them are executed or none.</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> balance <span class="token keyword">FROM</span> checking <span class="token keyword">WHERE</span> customer_id <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> checking <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">200.00</span> <span class="token keyword">WHERE</span> customer_id <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> savings <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">200.00</span> <span class="token keyword">WHERE</span> customer_id <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span></code></pre></div>
<h3>ACID</h3>
<p>the criteria that a well-behaved transaction processing system must meet:</p>
<ul>
<li>Atomicity</li>
<li>Consistency</li>
<li>Isolation</li>
<li>Durability</li>
</ul>
<h3>Isolation level</h3>
<p>Isolation level is related to transactions and concurrency. It defines how to sperate each transaction from other concurrently running transactions.</p>
<p>The SQL standard defines four isolation levels, with specific rules for which changes are and aren't visible inside and outside a transaction:
| Level | Description | Lock |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| <code class="language-text">READ UNCOMMITED</code> | The lowest level. Basically no isolation. Transactions can view the results of uncommited transactions (aka. <em>dirty read</em>). This level is rarely used in practice. | no lock |
| <code class="language-text">READ COMMITTED</code> | Transaction will see only chances made by transactions that were already commited, and its changes won't be visible to others until it has commited. However, this level allows <em>nonrepeatable read</em>, which means you can run the same <code class="language-text">SELECT</code> statement twice and see different results, because they each use a different snapshot of data. | |
| <code class="language-text">REPEATABLE READ</code> (<strong>default</strong>) | Gurantees same results from multiple read in a transaction. Still allows <em>phantom read</em>, which can happen when we read a range of rows but another transaction inserted a new row in the range. The inserted row will be read by current transaction, so called phantom. (InnonDB has <strong>MVCC</strong> to solve this problem). | lock write |
| <code class="language-text">SERIALIZABLE</code> | The highest level. Gurantees no phantom read by locking every row it reads, forcing transactions to be ordered. | S lock for read, X lock for write |</p>
<p>Note that higher isolation level operates with more overheads, so generally the performance and concurrency is worse. It's always a trade-off.</p>
<h4>Difference between non-repeatable read &#x26; phantom read:</h4>
<ul>
<li>In <code class="language-text">READ COMMITED</code>, read doesn't place lock. Update and delete of selected role can still happen, consequently you would read different results in subsequent reads.</li>
<li>In <code class="language-text">REPEATABLE READ</code>, read locks rows from updating/deletion, but it does not prevent insertion. Insertion can still happen which would results in phantom read in subsequent reads.</li>
</ul>
<h4>MVCC (multi-version concurrency control)</h4>
<p>Store 2 hidden value with each row, one for</p>
<h2>Locking</h2>
<h3>Optimistic lock</h3>
<p>乐观锁（Optimistic Lock），顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在提交更新的时候会判断一下在此期间别人有没有去更新这个数据。乐观锁适用于读多写少的应用场景，这样可以提高吞吐量。</p>
<p>乐观锁一般来说有以下 2 种方式：</p>
<ol>
<li>使用数据版本（Version）记录机制实现，这是乐观锁最常用的一种实现方式</li>
<li>使用时间戳（timestamp）</li>
</ol>
<p>Java 中的 atomic 包就是乐观锁的一种实现，AtomicInteger 通过 CAS（Compare And Set）操作实现线程安全的自增。</p>
<h3>Pessimistic lock</h3>
<p>顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁。</p>
<p>Java 的 <code class="language-text">synchronized</code> 就属于悲观锁的一种实现，每次线程要修改数据时都先获得锁，保证同一时刻只有一个线程能操作数据，其他线程则会被 block。</p>
<h3>MySQL 隐式和显示锁定</h3>
<p>MySQL InnoDB 采用的是两阶段锁定协议（two-phase locking protocol）。在事务执行过程中，随时都可以执行锁定，锁只有在执行 <code class="language-text">COMMIT</code>或者<code class="language-text">ROLLBACK</code>的时候才会释放，并且所有的锁是在同一时刻被释放。前面描述的锁定都是隐式锁定，InnoDB 会根据事务隔离级别在需要的时候自动加锁。</p>
<p>另外，InnoDB 也支持通过特定的语句进行显示锁定，这些语句不属于 SQL 规范：</p>
<p>SELECT ... LOCK IN SHARE MODE</p>
<p>SELECT ... FOR UPDATE</p>
<h2>Storage Engines</h2>
<h3>InnoDB</h3>
<h3>MyISAM</h3>
<h3>Main difference: InnoDB &#x26; MyISAM</h3>
<ul>
<li>InnoDB has row-level locking, MyISAM only have full table lock.</li>
<li>InnoDB has support for transactions.</li>
<li>InnoDB has foreign key and constraints.</li>
</ul>
<h2>Indexing</h2>
<p>Indexes are data structures the storage engines use to lookup rows quickly.</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> myindex <span class="token keyword">ON</span> order_table<span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> create_date<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>or with unique constraint</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> myindex <span class="token keyword">ON</span> order_table<span class="token punctuation">(</span>product_id<span class="token punctuation">,</span> create_date<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3>BTREE Index</h3>
<p>BTREE here is refering a class of index MySQL uses. However, the actual data structure used differs among storage engines. For example, NDB uses T-Tree and InnoDB uses B+Tree.</p>
<h4>Data Structure: B-Tree</h4>
<p>B-Tree is a self-balancing m-ary tree (m > 2). B-tree maintains sorted data and allow searches, insert, delete in <code class="language-text">O(logN)</code> time. B-Tree is commonly used in file systems and databases.</p>
<blockquote>
<p><strong>Note: Why not use a balanced binary tree?</strong> - Each node in a B-Tree can represent much more data, which reduce the height of the tree. Because database need to read data from disk storage in to memory, a reduced height means less disk I/O and better performance.</p>
</blockquote>
<h4>Data Structure: B+Tree</h4>
<p>B+Tree is a variation of B-Tree:</p>
<ul>
<li>
<p>number of key is the same as number of children</p>
<ul>
<li>This is unlike B-Tree, where a node with <code class="language-text">n</code> keys has <code class="language-text">n + 1</code> children. In B+Tree, the key represent the maximum value a child can have.</li>
</ul>
</li>
<li>non-leaf node are only used for indexing and not data reading.</li>
<li>leaf nodes have all the data, and each leaf node has a pointer to the adjacent node (as a linked list).</li>
</ul>
<p>The advantage of using B+Tree:</p>
<ul>
<li>In practice, because B+Tree's non-leaf node hold less data, a storage page can store more entries per node. This reduces the height of the tree by more, and leads to less disk I/O.</li>
<li>The leaf nodes is a sorted linked list, makes it more efficient to search range of data.</li>
</ul>
<h3>Hash Index</h3>
<p>Implemented using hash table.
Memory storage engine</p>
<h3>Cluster Index</h3>
<p>Cluster index is not a index, but it is rather about how the index is stored. InnoDB stores the index and the rows together in the same structure (in leaf pages). InnoDB clusters the data by the primary key.</p>
<h2>Optimizing index</h2>
<h2>MySQL vs MongoDB?</h2>
<ul>
<li>Fixed schema vs dynamic schema.</li>
<li>Mongodb is document-oriented. stores data in json format (BSON)</li>
<li>
<p>MySQL is vertically scalable, while mongodb is horizontally scalable.</p>
<ul>
<li>MySQL master-slave structure scales read, but write is still limitation. MongoDB sharding distribute both read and write.</li>
</ul>
</li>
<li>MySQL has table-based relational structure.</li>
</ul>
<h2>MySQL scaling</h2>
<h2>RDBS Database normalization</h2>
<p>not normalized database have data redundancy.</p>
<h3>1NF</h3>
<p>column value should be single (not like an array of values)
values stored in column should be of the same domain
column have unique names
order does not matter</p>
<h3>2NF</h3>
<p>must be in 1NF
no partial dependency. (all column value is dependent on primary key)</p>
<h3>3NF</h3>
<p>must be in 2NF
no transitive dependency.</p>
<h3>BCNF</h3>
<p>must be in 3NF
each functional dependency (x -> y), x should be a super key</p>
<h3>4NF</h3>
<p>must be in BCNF
no multi-valued-dependency</p></div></div></div></main></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/mysql";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3326c647442d9cdf5b1f.js"],"component---src-pages-404-js":["/component---src-pages-404-js-005d451c2fb3da42cb0f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b412d5317ae6b05c9f06.js"],"component---src-templates-notes-js":["/component---src-templates-notes-js-d8a721f12764927d7a7b.js"]};/*]]>*/</script><script src="/cs-notes/component---src-templates-notes-js-d8a721f12764927d7a7b.js" async=""></script><script src="/cs-notes/3925cf68b2c2d0cc1d85efad3e08a114191829f9-472ce0b777b01331616f.js" async=""></script><script src="/cs-notes/styles-6b8affa5cc22cb60670e.js" async=""></script><script src="/cs-notes/app-3326c647442d9cdf5b1f.js" async=""></script><script src="/cs-notes/framework-a74044b4add31353c05b.js" async=""></script><script src="/cs-notes/webpack-runtime-5bb415d6ec02a3077fde.js" async=""></script></body></html>